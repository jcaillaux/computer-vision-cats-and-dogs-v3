# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš¨ GRAFANA ALERT RULES - RÃ¨gles d'alerting MLOps
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ğŸ¯ OBJECTIF
# DÃ©finit les rÃ¨gles d'alerte Grafana Unified Alerting pour monitoring proactif.
# Format YAML gÃ©nÃ©rÃ© par Grafana UI (export), structurÃ© pour provisioning.
#
# ğŸ“š CONCEPTS CLÃ‰S
# - Alert rule : condition + donnÃ©es + seuil + durÃ©e
# - Query (data) : source mÃ©triques (Prometheus, SQL, etc.)
# - Condition (threshold) : Ã©valuation boolÃ©enne (>, <, ==)
# - for : durÃ©e avant dÃ©clenchement (anti-faux positifs)
# - noDataState/execErrState : comportement si donnÃ©es manquantes
#
# ğŸ”— WORKFLOW
# Query Prometheus â†’ Reduce â†’ Threshold â†’ Fire/Resolve â†’ Contact Point (Discord)
#
# âš ï¸ FORMAT COMPLEXE
# Ce YAML est verbeux car exportÃ© depuis Grafana UI.
# CrÃ©ation manuelle difficile â†’ privilÃ©gier crÃ©ation UI puis export.
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

apiVersion: 1

groups:
  - orgId: 1
    name: cv-monitoring
    folder: Computer Vision
    interval: 1m
    
    rules:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”´ ALERTE 1 : Base de donnÃ©es dÃ©connectÃ©e (CRITICAL)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - uid: cv-db-disconnected
        title: Database Disconnected
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: cv_database_connected
              instant: true
              range: false
              refId: A
          
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: lt
                  reducer:
                    type: last
                  type: query
              expression: A
              type: threshold
        
        noDataState: Alerting
        execErrState: Alerting
        for: 1m
        annotations:
          description: L'API ne peut plus accÃ©der Ã  PostgreSQL
          summary: Base de donnÃ©es PostgreSQL dÃ©connectÃ©e
        labels:
          severity: critical
        isPaused: false

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âš ï¸ ALERTE 2 : Latence d'infÃ©rence Ã©levÃ©e (WARNING)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - uid: cv-high-latency
        title: High Inference Latency
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: rate(cv_inference_time_seconds_sum[5m]) / rate(cv_inference_time_seconds_count[5m])
              instant: true
              range: false
              refId: A
          
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 2
                    type: gt
                  reducer:
                    type: last
                  type: query
              expression: A
              type: threshold
        
        noDataState: NoData
        execErrState: Error
        for: 2m
        annotations:
          description: "La latence moyenne d'infÃ©rence dÃ©passe 2 secondes depuis 2 minutes. VÃ©rifier charge CPU/GPU et modÃ¨le."
          summary: "Latence d'infÃ©rence Ã©levÃ©e (> 2s)"
        labels:
          severity: warning
          component: inference
        isPaused: false

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ STRUCTURE ALERT RULE GRAFANA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# PIPELINE D'Ã‰VALUATION (exemple alerte latence)
# 1. Query A (Prometheus) : rÃ©cupÃ¨re mÃ©trique histogram
# 2. Calcul (PromQL) : rate(sum) / rate(count) â†’ latence moyenne
# 3. Query B (Reduce) : extrait derniÃ¨re valeur â†’ scalaire
# 4. Query C (Threshold) : compare scalaire > seuil â†’ boolÃ©en
# 5. For duration : condition vraie pendant N minutes ?
# 6. Fire : dÃ©clenche notification â†’ contact point (Discord)
#
# Ã‰TATS POSSIBLES
# - Normal : condition false
# - Pending : condition true mais <for duration (pas encore notifiÃ©)
# - Firing : condition true depuis >for duration (notification envoyÃ©e)
# - Resolved : Ã©tait firing, maintenant normal (notification rÃ©solution)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ› ï¸ CRÃ‰ATION NOUVELLES ALERTES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# MÃ‰THODE RECOMMANDÃ‰E (UI Grafana)
# 1. Dashboard â†’ panel existant â†’ Edit
# 2. Tab "Alert" â†’ Create alert rule
# 3. Configurer condition graphiquement
# 4. Test avec "Preview" (donnÃ©es rÃ©elles)
# 5. Save
# 6. Exporter : Alerting â†’ Alert rules â†’ Export as YAML
# 7. Ajouter Ã  cv-alerts.yml
#
# âš ï¸ CRÃ‰ATION MANUELLE YAML (difficile)
# Format complexe, queries imbriquÃ©es, refIds multiples
# PrivilÃ©gier UI â†’ export pour Ã©viter erreurs syntaxe
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”§ TESTS ET DEBUG
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# TEST ALERTE (forcer dÃ©clenchement)
# - DB disconnect : docker compose stop postgres
# - High latency : surcharger CPU (stress test)
# - No activity : arrÃªter frontend/stop prÃ©dictions
#
# MONITORING ALERTES
# Grafana UI â†’ Alerting â†’ Alert rules
# - Ã‰tat : Normal, Pending, Firing
# - Historique : derniers dÃ©clenchements
# - Silences : dÃ©sactiver temporairement
#
# DEBUG QUERY
# Grafana UI â†’ Explore â†’ datasource Prometheus
# - Copier expr depuis cv-alerts.yml
# - Tester query isolÃ©ment
# - VÃ©rifier valeurs retournÃ©es
#
# LOGS GRAFANA
# docker compose logs grafana | grep -i alert
# - "provisioning alert rules"
# - "alert rule ... is firing"
# - Erreurs d'Ã©valuation
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“š RESSOURCES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# - Unified Alerting : https://grafana.com/docs/grafana/latest/alerting/
# - Provisioning : https://grafana.com/docs/grafana/latest/alerting/set-up/provision-alerting-resources/
# - Query expressions : https://grafana.com/docs/grafana/latest/panels-visualizations/query-transform-data/expression-queries/
# - PromQL functions : https://prometheus.io/docs/prometheus/latest/querying/functions/
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•